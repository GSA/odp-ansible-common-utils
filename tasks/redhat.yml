---

- name: Download EPEL release
  get_url:
    url: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm"
    dest: "{{  download_home }}/"
    
- name: Install Python pip
  yum:
    name: "{{ item }}"
    state: present
  loop:
  - python3-pip
  - "{{  download_home }}/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm"
  - collectd

- name: upgrade all packages
  yum:
    name: "*"
    state: latest

- name: Download CloudWatch agent Signature file
  get_url:
    url: "{{ redhat.cwa_signature_link }}"
    dest: "{{  download_home }}/"

- name: Download CloudWatch agent Installer package file
  get_url:
    url: "{{ redhat.cwa_package_link }}"
    dest: "{{  download_home }}/"

- name: Verify downloaded package signature
  command: gpg --verify {{ redhat.cwa_signature }} {{ redhat.cwa_package }}
  register: verified_sig
  failed_when: "'BAD' in verified_sig.stderr"
  changed_when: false
  args:
    chdir: "{{ download_home }}"

- name: Install CloudWatch agent 
  yum:
    name: "{{ download_home }}/{{ redhat.cwa_package }}"
    disable_gpg_check: true
    state: present
