---

- name: Make sure universe repository is enabled
  apt_repository:
    repo: "{{ item }}"
    state: present
    update_cache: True
  with_items:
    - "deb http://archive.ubuntu.com/ubuntu bionic universe"
    - "ppa:ubuntu-toolchain-r/ppa"
  ignore_errors: yes

- name: Install necessary packages
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  with_items:
    - python3-pip
    - collectd

- name: Download CloudWatch agent Signature file
  get_url:
    url: "{{ ubuntu.cwa_signature_link }}"
    dest: "{{  download_home }}/"

- name: Download CloudWatch agent Installer package file
  get_url:
    url: "{{ ubuntu.cwa_package_link }}"
    dest: "{{  download_home }}/"

- name: Verify downloaded package signature
  command: gpg --verify {{ ubuntu.cwa_signature }} {{ ubuntu.cwa_package }}
  register: verified_sig
  failed_when: "'BAD' in verified_sig.stderr or 'gpg: no valid OpenPGP data found' in verified_sig.stderr"
  changed_when: false
  args:
    chdir: "{{ download_home }}"

- name: Install CloudWatch agent 
  apt:
    deb: "{{ download_home }}/{{ ubuntu.cwa_package }}"
    state: present
